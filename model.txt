import requests
import xml.etree.ElementTree as ET
import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
import zipfile
import io
import os
import numpy as np
from matplotlib.patches import Rectangle
import warnings
warnings.filterwarnings('ignore')

# í•œê¸€ í°íŠ¸ ì„¤ì • (Colabìš©)
plt.rcParams['font.family'] = 'DejaVu Sans'
plt.rcParams['axes.unicode_minus'] = False

# ğŸ“Œ DART API KEY ì…ë ¥
api_key = "e7153f9582f89deb2169769816dcc61c826bd5cf"

# 1. corpCode.zip ë‹¤ìš´ë¡œë“œ ë° ì••ì¶• í•´ì œ
def download_and_extract_corp_code():
    url = f"https://opendart.fss.or.kr/api/corpCode.xml?crtfc_key={api_key}"
    res = requests.get(url)
    if res.status_code == 200:
        with open("corpCode.zip", "wb") as f:
            f.write(res.content)
        print("âœ… corpCode.zip ë‹¤ìš´ë¡œë“œ ì™„ë£Œ")

        with zipfile.ZipFile("corpCode.zip", "r") as zip_ref:
            zip_ref.extractall()
        print("âœ… corpCode.zip ì••ì¶• í•´ì œ ì™„ë£Œ")
        return True
    else:
        print(f"âŒ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: {res.status_code}")
        return False

# 2. íšŒì‚¬ëª…ìœ¼ë¡œ corp_code ê²€ìƒ‰
def get_corp_code(company_name):
    tree = ET.parse("CORPCODE.xml")
    root = tree.getroot()
    exact_match = None
    partial_matches = []
    for item in root.iter("list"):
        name = item.find("corp_name").text
        code = item.find("corp_code").text
        if name == company_name:
            exact_match = code
            print(f"ğŸ” ì •í™•íˆ ì¼ì¹˜í•˜ëŠ” íšŒì‚¬ëª… ë§¤ì¹­: {name}")
            break
        elif company_name in name:
            partial_matches.append((name, code))
    if exact_match:
        return exact_match
    elif partial_matches:
        print("ğŸ” ë¶€ë¶„ ì¼ì¹˜í•˜ëŠ” íšŒì‚¬ëª… í›„ë³´:")
        for n, c in partial_matches:
            print(f"  - {n} : {c}")
        print("â— ì •í™•í•œ íšŒì‚¬ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.")
        return None
    else:
        print(f"âŒ '{company_name}'ì— í•´ë‹¹í•˜ëŠ” corp_codeë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
        return None

# 3. ì£¼ìš” ì¬ë¬´ì§€í‘œ ìš”ì²­ í•¨ìˆ˜
def get_index_data(corp_code, year, reprt_code, idx_cl_code):
    url = "https://opendart.fss.or.kr/api/fnlttSinglIndx.json"
    params = {
        "crtfc_key": api_key,
        "corp_code": corp_code,
        "bsns_year": year,
        "reprt_code": reprt_code,
        "idx_cl_code": idx_cl_code
    }
    res = requests.get(url, params=params)
    data = res.json()
    
    if data["status"] != "000":
        print(f"âŒ API ì—ëŸ¬: {data['message']}")
        return pd.DataFrame()

    df = pd.DataFrame(data["list"])
    df["idx_val"] = pd.to_numeric(df["idx_val"], errors="coerce")
    return df[["idx_cl_nm", "idx_nm", "idx_val"]]

# 4. ëª¨ë“  ì§€í‘œ ë¶„ë¥˜ ì¡°íšŒ
def fetch_all_indexes(corp_code, year="2023", reprt_code="11014"):
    idx_cl_codes = {
        "M210000": "ìˆ˜ìµì„±",
        "M220000": "ì•ˆì •ì„±",
        "M230000": "ì„±ì¥ì„±",
        "M240000": "í™œë™ì„±"
    }
    all_data = pd.DataFrame()
    for code, name in idx_cl_codes.items():
        print(f"ğŸ“¥ {name} ì§€í‘œ ê°€ì ¸ì˜¤ëŠ” ì¤‘...")
        df = get_index_data(corp_code, year, reprt_code, code)
        if not df.empty:
            all_data = pd.concat([all_data, df], ignore_index=True)
    return all_data

# 5. ì§€í‘œë³„ í•´ì„ ê¸°ì¤€ ì •ì˜
def get_interpretation(category, metric_name, value):
    """ì§€í‘œê°’ì— ëŒ€í•œ í•´ì„ ì œê³µ"""
    interpretations = {
        "ìˆ˜ìµì„±": {
            "default": {
                "excellent": (15, "ğŸ’° ë§¤ìš° ìš°ìˆ˜", "#1f77b4"),
                "good": (10, "ğŸ‘ ì–‘í˜¸", "#2ca02c"), 
                "average": (5, "âš–ï¸ ë³´í†µ", "#ff7f0e"),
                "poor": (0, "âš ï¸ ê°œì„ í•„ìš”", "#d62728")
            }
        },
        "ì•ˆì •ì„±": {
            "default": {
                "excellent": (200, "ğŸ›¡ï¸ ë§¤ìš° ì•ˆì •", "#1f77b4"),
                "good": (150, "âœ… ì•ˆì •", "#2ca02c"),
                "average": (100, "âš–ï¸ ë³´í†µ", "#ff7f0e"), 
                "poor": (0, "âš ï¸ ë¶ˆì•ˆì •", "#d62728")
            }
        },
        "ì„±ì¥ì„±": {
            "default": {
                "excellent": (20, "ğŸš€ ê³ ì„±ì¥", "#1f77b4"),
                "good": (10, "ğŸ“ˆ ì„±ì¥", "#2ca02c"),
                "average": (0, "âš–ï¸ ë³´í†µ", "#ff7f0e"),
                "poor": (-10, "ğŸ“‰ ê°ì†Œ", "#d62728")
            }
        },
        "í™œë™ì„±": {
            "default": {
                "excellent": (5, "âš¡ ë§¤ìš° í™œë°œ", "#1f77b4"),
                "good": (3, "ğŸ”„ í™œë°œ", "#2ca02c"),
                "average": (1, "âš–ï¸ ë³´í†µ", "#ff7f0e"),
                "poor": (0, "ğŸŒ ì €ì¡°", "#d62728")
            }
        }
    }
    
    criteria = interpretations.get(category, {}).get("default", interpretations["ìˆ˜ìµì„±"]["default"])
    
    for level, (threshold, label, color) in criteria.items():
        if value >= threshold:
            return label, color
    
    return criteria["poor"][1], criteria["poor"][2]

# 6. ëŒ€ì‹œë³´ë“œ ìŠ¤íƒ€ì¼ ì¢…í•© ì‹œê°í™”
def create_financial_dashboard(df, company_name, year):
    """ì¢…í•© ì¬ë¬´ ëŒ€ì‹œë³´ë“œ ìƒì„±"""
    fig = plt.figure(figsize=(20, 16))
    fig.suptitle(f'ğŸ“Š {company_name} ì¬ë¬´ì§€í‘œ ì¢…í•© ëŒ€ì‹œë³´ë“œ ({year}ë…„)', 
                 fontsize=24, fontweight='bold', y=0.98)
    
    categories = df["idx_cl_nm"].unique()
    
    # 2x2 ê·¸ë¦¬ë“œë¡œ ê° ì¹´í…Œê³ ë¦¬ ë°°ì¹˜
    positions = [(2, 2, 1), (2, 2, 2), (2, 2, 3), (2, 2, 4)]
    colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4']
    
    for i, category in enumerate(categories):
        if i >= len(positions):
            break
            
        sub_df = df[df["idx_cl_nm"] == category].copy()
        if sub_df.empty:
            continue
            
        ax = plt.subplot(*positions[i])
        
        # ì¹´í…Œê³ ë¦¬ë³„ ì•„ì´ì½˜
        icons = {'ìˆ˜ìµì„±': 'ğŸ’°', 'ì•ˆì •ì„±': 'ğŸ›¡ï¸', 'ì„±ì¥ì„±': 'ğŸš€', 'í™œë™ì„±': 'âš¡'}
        icon = icons.get(category, 'ğŸ“Š')
        
        # ìˆ˜í‰ ë§‰ëŒ€ ê·¸ë˜í”„
        y_pos = np.arange(len(sub_df))
        bars = ax.barh(y_pos, sub_df['idx_val'], color=colors[i], alpha=0.8, height=0.6)
        
        # ì§€í‘œëª… ì„¤ì • (ì¶•ì•½)
        labels = [name.replace('(', '\n(') for name in sub_df['idx_nm']]
        ax.set_yticks(y_pos)
        ax.set_yticklabels(labels, fontsize=9)
        
        # ê°’ í‘œì‹œ
        for j, (bar, val) in enumerate(zip(bars, sub_df['idx_val'])):
            interpretation, color = get_interpretation(category, sub_df.iloc[j]['idx_nm'], val)
            ax.text(bar.get_width() + max(sub_df['idx_val']) * 0.01, 
                   bar.get_y() + bar.get_height()/2, 
                   f'{val:.2f}', ha='left', va='center', fontweight='bold')
            ax.text(bar.get_width() + max(sub_df['idx_val']) * 0.15, 
                   bar.get_y() + bar.get_height()/2, 
                   interpretation, ha='left', va='center', fontsize=8)
        
        ax.set_title(f'{icon} {category}', fontsize=14, fontweight='bold', pad=15)
        ax.set_xlabel('ì§€í‘œê°’', fontsize=10)
        ax.grid(True, alpha=0.3, axis='x')
        ax.spines['top'].set_visible(False)
        ax.spines['right'].set_visible(False)
    
    plt.tight_layout()
    plt.subplots_adjust(top=0.93, hspace=0.3, wspace=0.3)
    plt.show()

# 7. ì¹´í…Œê³ ë¦¬ë³„ ìƒì„¸ ë¶„ì„ ì‹œê°í™”
def create_detailed_analysis(df, company_name, year):
    """ì¹´í…Œê³ ë¦¬ë³„ ìƒì„¸ ë¶„ì„"""
    categories = df["idx_cl_nm"].unique()
    
    for category in categories:
        sub_df = df[df["idx_cl_nm"] == category].copy()
        if sub_df.empty:
            continue
            
        plt.figure(figsize=(14, 8))
        
        # ë°°ê²½ ìƒ‰ìƒ ì„¤ì •
        colors_dict = {'ìˆ˜ìµì„±': '#FFE5E5', 'ì•ˆì •ì„±': '#E5F9F6', 
                      'ì„±ì¥ì„±': '#E5F3FF', 'í™œë™ì„±': '#F0F8E5'}
        plt.gca().set_facecolor(colors_dict.get(category, '#F8F9FA'))
        
        # ì§€í‘œê°’ì— ë”°ë¥¸ ìƒ‰ìƒ ë§¤í•‘
        bar_colors = []
        interpretations = []
        
        for _, row in sub_df.iterrows():
            interp, color = get_interpretation(category, row['idx_nm'], row['idx_val'])
            bar_colors.append(color)
            interpretations.append(interp)
        
        # ìˆ˜ì§ ë§‰ëŒ€ ê·¸ë˜í”„
        bars = plt.bar(range(len(sub_df)), sub_df['idx_val'], 
                      color=bar_colors, alpha=0.8, width=0.6)
        
        # ê°’ê³¼ í•´ì„ í‘œì‹œ
        for i, (bar, val, interp) in enumerate(zip(bars, sub_df['idx_val'], interpretations)):
            plt.text(bar.get_x() + bar.get_width()/2, bar.get_height() + max(sub_df['idx_val']) * 0.01,
                    f'{val:.2f}', ha='center', va='bottom', fontweight='bold', fontsize=11)
            plt.text(bar.get_x() + bar.get_width()/2, bar.get_height() + max(sub_df['idx_val']) * 0.08,
                    interp, ha='center', va='bottom', fontsize=9, 
                    bbox=dict(boxstyle="round,pad=0.3", facecolor='white', alpha=0.8))
        
        # ì¶• ì„¤ì •
        plt.xticks(range(len(sub_df)), 
                  [name.replace('(', '\n(') for name in sub_df['idx_nm']], 
                  rotation=45, ha='right')
        plt.ylabel('ì§€í‘œê°’', fontsize=12)
        
        # ì œëª©ê³¼ ì•„ì´ì½˜
        icons = {'ìˆ˜ìµì„±': 'ğŸ’°', 'ì•ˆì •ì„±': 'ğŸ›¡ï¸', 'ì„±ì¥ì„±': 'ğŸš€', 'í™œë™ì„±': 'âš¡'}
        icon = icons.get(category, 'ğŸ“Š')
        plt.title(f'{icon} {company_name} - {category} ì§€í‘œ ìƒì„¸ë¶„ì„ ({year}ë…„)', 
                 fontsize=16, fontweight='bold', pad=20)
        
        # í‰ê· ì„  ì¶”ê°€
        avg_val = sub_df['idx_val'].mean()
        plt.axhline(y=avg_val, color='red', linestyle='--', alpha=0.7, 
                   label=f'í‰ê· ê°’: {avg_val:.2f}')
        plt.legend()
        
        # ê²©ìì™€ ìŠ¤íƒ€ì¼
        plt.grid(True, alpha=0.3, axis='y')
        plt.gca().spines['top'].set_visible(False)
        plt.gca().spines['right'].set_visible(False)
        
        plt.tight_layout()
        plt.show()
        
        # ì¹´í…Œê³ ë¦¬ë³„ í•´ì„ í…ìŠ¤íŠ¸
        print(f"\nğŸ“‹ {category} ì§€í‘œ í•´ì„:")
        print("=" * 50)
        for _, row in sub_df.iterrows():
            interp, _ = get_interpretation(category, row['idx_nm'], row['idx_val'])
            print(f"â€¢ {row['idx_nm']}: {row['idx_val']:.2f} â†’ {interp}")

# 8. ë ˆì´ë” ì°¨íŠ¸ë¡œ ì¢…í•© í‰ê°€
def create_radar_chart(df, company_name, year):
    """ë ˆì´ë” ì°¨íŠ¸ë¡œ ì¢…í•© ì¬ë¬´ ê±´ì „ì„± í‘œì‹œ"""
    category_scores = {}
    
    for category in df["idx_cl_nm"].unique():
        sub_df = df[df["idx_cl_nm"] == category]
        # ê° ì¹´í…Œê³ ë¦¬ì˜ í‰ê·  ì ìˆ˜ ê³„ì‚° (0-100 ìŠ¤ì¼€ì¼ë¡œ ì •ê·œí™”)
        avg_score = sub_df['idx_val'].mean()
        
        # ì¹´í…Œê³ ë¦¬ë³„ ì ìˆ˜ ì •ê·œí™” (ì‹¤ì œ ë°ì´í„°ì— ë§ê²Œ ì¡°ì • í•„ìš”)
        if category == "ìˆ˜ìµì„±":
            normalized_score = min(100, max(0, avg_score * 5))
        elif category == "ì•ˆì •ì„±":
            normalized_score = min(100, max(0, avg_score / 2))
        elif category == "ì„±ì¥ì„±":
            normalized_score = min(100, max(0, (avg_score + 20) * 2.5))
        else:  # í™œë™ì„±
            normalized_score = min(100, max(0, avg_score * 20))
            
        category_scores[category] = normalized_score
    
    # ë ˆì´ë” ì°¨íŠ¸ ìƒì„±
    categories = list(category_scores.keys())
    values = list(category_scores.values())
    
    # ê°ë„ ê³„ì‚°
    angles = np.linspace(0, 2 * np.pi, len(categories), endpoint=False)
    values += values[:1]  # ì²« ë²ˆì§¸ ê°’ì„ ë§ˆì§€ë§‰ì— ì¶”ê°€í•˜ì—¬ ì°¨íŠ¸ë¥¼ ë‹«ìŒ
    angles = np.concatenate((angles, [angles[0]]))
    
    fig, ax = plt.subplots(figsize=(10, 10), subplot_kw=dict(projection='polar'))
    
    # ë ˆì´ë” ì°¨íŠ¸ ê·¸ë¦¬ê¸°
    ax.plot(angles, values, 'o-', linewidth=3, color='#FF6B6B', alpha=0.8)
    ax.fill(angles, values, alpha=0.25, color='#FF6B6B')
    
    # ì¹´í…Œê³ ë¦¬ ë¼ë²¨
    ax.set_xticks(angles[:-1])
    icons = ['ğŸ’°', 'ğŸ›¡ï¸', 'ğŸš€', 'âš¡']
    ax.set_xticklabels([f'{icon}\n{cat}' for icon, cat in zip(icons, categories)], 
                       fontsize=12)
    
    # ì ìˆ˜ í‘œì‹œ
    for angle, value, category in zip(angles[:-1], values[:-1], categories):
        ax.text(angle, value + 5, f'{value:.1f}', ha='center', va='center', 
               fontweight='bold', fontsize=10,
               bbox=dict(boxstyle="round,pad=0.3", facecolor='white', alpha=0.8))
    
    ax.set_ylim(0, 100)
    ax.set_title(f'ğŸ¯ {company_name} ì¢…í•© ì¬ë¬´ê±´ì „ì„± ë ˆì´ë” ({year}ë…„)', 
                fontsize=16, fontweight='bold', pad=30)
    
    # ê²©ìì„ 
    ax.grid(True, alpha=0.3)
    ax.set_rticks([20, 40, 60, 80, 100])
    
    plt.tight_layout()
    plt.show()
    
    # ì¢…í•© í‰ê°€
    overall_score = np.mean(values[:-1])
    if overall_score >= 80:
        grade = "A+ (ë§¤ìš°ìš°ìˆ˜)"
    elif overall_score >= 70:
        grade = "A (ìš°ìˆ˜)"
    elif overall_score >= 60:
        grade = "B (ì–‘í˜¸)"
    elif overall_score >= 50:
        grade = "C (ë³´í†µ)"
    else:
        grade = "D (ê°œì„ í•„ìš”)"
    
    print(f"\nğŸ† {company_name} ì¢…í•© ì¬ë¬´ê±´ì „ì„± í‰ê°€")
    print("=" * 50)
    print(f"ì¢…í•© ì ìˆ˜: {overall_score:.1f}/100ì ")
    print(f"í‰ê°€ ë“±ê¸‰: {grade}")

# 9. ì‹¤í–‰ ë¶€ë¶„
def main():
    company_name = "ì‚¼ì„±ì „ì"
    year = "2023"
    reprt_code = "11014"  # 3ë¶„ê¸° ë³´ê³ ì„œ

    print(f"ğŸ” {company_name}ì˜ {year}ë…„ ì¬ë¬´ì§€í‘œ ë¶„ì„ì„ ì‹œì‘í•©ë‹ˆë‹¤...")
    
    if download_and_extract_corp_code():
        corp_code = get_corp_code(company_name)
        if corp_code:
            all_data = fetch_all_indexes(corp_code, year, reprt_code)
            if not all_data.empty:
                print(f"\nğŸ“Š ì´ {len(all_data)}ê°œì˜ ì¬ë¬´ì§€í‘œë¥¼ ìˆ˜ì§‘í–ˆìŠµë‹ˆë‹¤.")
                
                # 1. ì¢…í•© ëŒ€ì‹œë³´ë“œ
                print("\nğŸ¨ ì¢…í•© ëŒ€ì‹œë³´ë“œ ìƒì„± ì¤‘...")
                create_financial_dashboard(all_data, company_name, year)
                
                # 2. ì¹´í…Œê³ ë¦¬ë³„ ìƒì„¸ ë¶„ì„
                print("\nğŸ“ˆ ì¹´í…Œê³ ë¦¬ë³„ ìƒì„¸ ë¶„ì„ ì¤‘...")
                create_detailed_analysis(all_data, company_name, year)
                
                # 3. ë ˆì´ë” ì°¨íŠ¸ ì¢…í•© í‰ê°€
                print("\nğŸ¯ ì¢…í•© í‰ê°€ ë ˆì´ë” ì°¨íŠ¸ ìƒì„± ì¤‘...")
                create_radar_chart(all_data, company_name, year)
                
            else:
                print("â— ìˆ˜ì§‘ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")

if __name__ == "__main__":
    main()